# A Database Administrator Workflow: 
# "Batch reconcile and post traditional versions".
# AKA "Running a scheduled nightly reconciliation of traditional versions".
#
# After my organizationâ€™s employees (the Surveyors, Data Analysts, System Engineers) have finished 
# making changes to an SDE dataset during their workday, it is up to the Database Admin (DBA) to merge 
# those daily changes into the master/parent dataset. The DBA can script this process to run nightly.

# import libraries.
import arcpy, time, smtplib

# Set the workspace. 
arcpy.env.workspace = 'C:\\Projects\\MyProject\\admin.sde'

# Set a variable for the workspace.
adminConn = arcpy.env.workspace

# Get a list of connected users.
userList = arcpy.ListUsers(adminConn)

# Get a list of user names of users currently connected and make email addresses.
emailList = [user.Name + "@yourorganization.com" for user in arcpy.ListUsers(adminConn)]

# Take the email list and use it to send an email to connected users.
SERVER = "mailserver.myorganization.com"
FROM = "SDE Admin <python@myorganization.com>"
TO = emailList
SUBJECT = "Maintenance is about to be performed"
MSG = "Auto generated Message.\n\rServer maintenance will be performed in 15 minutes. Please log off."

# Prepare actual message.
MESSAGE = """\
From: %s
To: %s
Subject: %s

%s
""" % ( FROM, ", ".join(TO), SUBJECT, MSG )

# Send the email.
print( "Sending email to connected users" )
server = smtplib.SMTP( SERVER )
server.sendmail( FROM, TO, MESSAGE )
server.quit()

# Block new connections to the database.
print( "The database is no longer accepting connections" )
arcpy.AcceptConnections( adminConn, False )

# Wait 15 minutes.
time.sleep(900)

# Disconnect all users from the database.
print( "Disconnecting all users" )
arcpy.DisconnectUser( adminConn, "ALL" )

# Get a list of versions to pass into the ReconcileVersions tool.
# Only reconcile versions that are children of Default.
print( "Compiling a list of versions to reconcile" )
verList = arcpy.da.ListVersions(adminConn)
versionList = [ver.name for ver in verList if ver.parentVersionName == 'sde.DEFAULT']

# Execute the ReconcileVersions tool.
print( "Reconciling all versions" )
arcpy.ReconcileVersions_management( adminConn
, "ALL_VERSIONS"
, "sde.DEFAULT"
, versionList
, "LOCK_ACQUIRED"
, "NO_ABORT"
, "BY_OBJECT"
, "FAVOR_TARGET_VERSION"
, "POST"
, "DELETE_VERSION"
, "c:/temp/reconcilelog.txt"
)

# Run the compress tool. 
print("Running compress")
arcpy.Compress_management( adminConn )

# Allow the database to begin accepting connections again.
print( "Allow users to connect to the database again" )
arcpy.AcceptConnections( adminConn, True )

# Update statistics and indexes for the system tables.
# Note: To use the "SYSTEM" option, the user must be a geodatabase or database
   administrator.
# Rebuild indexes on the system tables.
print( "Rebuilding indexes on the system tables" )
arcpy.RebuildIndexes_management( adminConn, "SYSTEM" )

# Update statistics on the system tables.
print("Updating statistics on the system tables")
arcpy.AnalyzeDatasets_management( adminConn, "SYSTEM" )

print( "Finished." )

# Once the script is completed, I can schedule it to run at set intervals, at a specific time, using the operating system's task scheduler.

